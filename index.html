<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Something to Cook</title>
    <script src="/src/animation.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            color: #f2f2f2;
        }
        html, body {
            background-color: #333333;
        }

        header {
            padding: 10px;
            background-color: #262626; 
            text-align: center;
        }
        header p {
            font-style: italic;            
            color: #666666;
        }

        main {
            padding: 5px 5px 29px 5px;
            text-align: center;
        }
        .filter {
            padding: 10px;
            margin: 5px auto;
            max-width: 600px;
            border-bottom: 2px solid rgba(166, 166, 166, 0.25);
        }
        .filter div {
            padding: 8px;
        }
        .filter ul li {
            display: inline-block;
            color: #595959;
            border: 2px solid #595959;
            border-radius: 4px;
            margin: 2px;
            padding: 5px;
            cursor: pointer;
            transition: color .25s, border-color .25s;
        }
        .filter ul li:focus, .filter ul li:hover {            
            color: #bfbfbf;
            border-color: #bfbfbf;
            outline: none;
        }
        .filter ul li.active {
            color: #cc6900;
            border-color: #cc6900;
        }
        .filter ul li.active:focus, .filter ul li.active:hover {            
            color: #ffa94d;
            border-color: #ffa94d;
            outline: none;
        }
        #filter-tags div {
            margin: 5px 0;
        }
        #filter-tags div input {
            display: none;
        }
        #filter-tags div input + label {
            display: inline-block;
            color: #595959;
            border: 2px solid #595959;
            border-radius: 4px;
            margin: 2px;
            padding: 5px;
            cursor: pointer;
            transition: color .25s, border-color .25s;
        }
        #filter-tags div input + label:focus, #filter-tags div input + label:hover {            
            color: #bfbfbf;
            border-color: #bfbfbf;
            outline: none;
        }
        #filter-tags div input:checked + label {
            color: #009933;
            border-color: #009933;
        }
        #filter-tags div input:checked + label:focus, #filter-tags div input:checked + label:hover {            
            color: #00cc44;
            border-color: #00cc44;
            outline: none;
        }

        #result {
            min-height: 350px;
        }
        #result-container {
            display: none;
            padding: 10px;
            margin: 5px auto;
            max-width: 600px;
            background-color: rgba(0, 230, 70, 0.05);
            border-bottom: 2px solid #009933;
        }
        #result-container h2 {
            padding: 5px;
        }
        #result-container p {
            padding: 5px;
            text-align: left;
        }
        .wikipedia-link {
            color: #8c8c8c;
        }
        .wikipedia-link:hover, .wikipedia-link:focus {
            color: #fff;
        }
        .search-recipe {
            display: block;
            margin: 10px;
            color: #f88000;
            transition: color .25s;
        }
        .search-recipe-variation {
            display: inline-block;
            margin: 10px;
            color: #f88000;
            transition: color .25s;
        }
        .search-recipe:hover, .search-recipe:focus, .search-recipe-variation:hover, .search-recipe-variation:focus {
            color: #ffa94d;
        }

        #cook-something-btn {
            background: #f88000;
            color: #d9d9d9;
            border: none;
            border-radius: 4px;
            padding: 15px;
            margin: 10px;
            font-size: 22px;
            cursor: pointer;
            transition: box-shadow .25s, color .25s;
        }
        #cook-something-btn:hover, #cook-something-btn:focus {
            box-shadow: 0 0 4px 2px rgba(0,0,0,0.5);
            color: #fff;
            outline: none;
        }

        #c_alert {
            display: none;
            position: fixed;
            top: 5px;
            left: 5px;
            right: 5px;
            padding: 5px;
            box-shadow: 0 0 2px 1px rgba(0,0,0,0.25);
            background-color: #4d4d4d;
            text-align: center;
            color: #f2f2f2;
        }
        #c_alert h1 {
            font-size: 24px;
        }
        #c_alert p {
            padding: 10px;    
        }
        #c_alert_close {
            background: #f88000;
            color: #d9d9d9;
            border: none;
            border-radius: 2px;
            padding: 5px;
            margin: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: box-shadow .25s, color .25s;
        }
        #c_alert_close:hover, #c_alert_close:focus {
            box-shadow: 0 0 4px 2px rgba(0,0,0,0.5);
            color: #fff;
            outline: none;
        }

        footer {
            position: fixed;
            right: 0;
            bottom: 0;
            left: 0;
            padding: 5px;
            background-color: #262626; 
        }
        footer p {
            font-size: 12px;
            font-style: italic;
            text-align: center;
            color: #666666;
        }
    </style>

</head>

<body>

    <header>
        <h1>Something To Cook</h1>
        <p>Pick some options below and lets help you decide on something to cook.</p>
    </header>

    <main>
        <div id="filter-container">
            <div class="filter" id="filter-categories">
                <h2>Categories</h2>
                <div>
                    <span>What the dish is really focused on or primarily centered around.</span>
                </div>
                <ul>
                    Loading...
                </ul>
            </div>

            <div class="filter" id="filter-origins">
                <h2>Origins</h2>
                <div>
                    <span>From what part of the world the dish originated or became popular.</span>
                </div>
                <ul>
                    Loading...
                </ul>
            </div>

            <div class="filter" id="filter-tags">
                <h2>Tags</h2>
                <div>
                    <span>Include meals with</span>
                    <input id="tags-method-1-btn" type="radio" name="tags-method" value="any" checked>
                        <label id="tags-method-1-label" for="tags-method-1-btn" tabIndex="0">Any</label>
                    <span> of these tags or include only meals with</span>
                    <input id="tags-method-2-btn" type="radio" name="tags-method" value="all">
                        <label id="tags-method-2-label" for="tags-method-2-btn" tabIndex="0">All</label>
                    <span>of these tags.</span>
                </div>
                <ul>
                    Loading...
                </ul>
            </div>
        </div>

        <button id="cook-something-btn" title="Find a meal!" onclick="getMeal()">Cook Something</button>

        <div id="result">
            <div id="result-container">
                <h2></h2>
                <p></p>
                <div></div>
            </div>
        </div>


    </main>

    <footer>
        <p>somethnigtocook.com | Copyright &copy; 2019 | Hosted on <a href="https://github.com/shnibble/SomethingToCook">Github</a></p>
    </footer>

    <script>
        "USE STRICT";

        // custom alert function
        function c_alert(title, msg) {

            // check for existing alert element and remove it
            let oldEl = document.getElementById("c_alert");
            if (oldEl !== null) {
                oldEl.remove();
            }

            // create new alert element using provided title and msg variables
            let el = document.createElement('div');
            el.id = "c_alert";
            el.innerHTML =
                `<h1>${title}</h1>` +
                `<p>${msg}</p>` +
                `<input type="button" id="c_alert_close" onclick="slideUp(this.parentElement, 250)" value="CLOSE">`;

            // append alert to document body
            document.body.appendChild(el);

            // animate slide down
            slideDown(el, 250);

        }

        // update filters function
        let categoriesFilter = [], 
            originsFilter = [], 
            tagsFilter = []; 

        function toggleFilter(el) {

            let existingIndex = null;
            let filterType = el.dataset.type;
            let filterName = el.innerText;
            let existingFilter = null;

            switch ( filterType ) {

                case "categories":
                    existingFilter = categoriesFilter;
                    break;

                case "origins":
                    existingFilter = originsFilter;
                    break;

                case "tags":
                    existingFilter = tagsFilter;
                    break;

                default:
                    console.log("Invalid filter type.");
                    return false;
            }

            
            existingIndex = existingFilter.indexOf(filterName);
            if ( existingIndex !== -1 ) {

                if ( filterType === "categories" && existingFilter.length <= 1 ) {

                    c_alert("Error", "You must have at least one category selected.");

                } else {
                
                    existingFilter.splice(existingIndex, 1);
                    el.classList.toggle("active");

                }

            } else {

                existingFilter.push(filterName);
                el.classList.toggle("active");

            }

        }

        // add "active" class toggle to li click events
        function applyListeners() {
            let filters = document.getElementsByClassName("filter");
            for ( let i = 0; i < filters.length; i++ ) {
                
                let fc = filters[i].children[2].children;

                for ( let n = 0; n < fc.length; n++ ) {

                    fc[n].addEventListener("click", function(){

                        toggleFilter(this);
                        this.blur();

                    })

                    fc[n].addEventListener("keydown", function(event){

                        if ( event.keyCode == 13 || event.keyCode == 32 ) {
                        
                            toggleFilter(this);
                            this.blur();

                        }

                    })

                }
            }
        }
        
        // add keyboard support for tag method radio buttons
        document.getElementById("tags-method-1-label").addEventListener("keydown", function(event){
            
            if ( event.keyCode == 13 || event.keyCode == 32 ) {
                
                this.blur();
                this.click();
                console.log("Test 1");

            }

        })
        document.getElementById("tags-method-2-label").addEventListener("keydown", function(event){
            
            if ( event.keyCode == 13 || event.keyCode == 32 ) {
                
                this.blur();
                this.click();
                console.log("Test 2");

            }

        })

        // get function
        function get(src) {

            return new Promise(function(resolve, reject) {

                let xhttp = new XMLHttpRequest();

                xhttp.onreadystatechange = function() {

                    if (this.readyState == 4) {

                        if (this.status == 200) {

                        resolve(this.responseText);

                        } else {

                        reject(Error(this.status));

                        }

                    }

                }

                xhttp.onerror = function() {

                    reject(Error("Network Error"));

                }

                xhttp.open('GET', src, true);
                xhttp.send();

            });

        }

        // buildDOM function
        function buildDOM(data) {
            
            let categoriesContainer   = document.getElementById("filter-categories"),
                originsContainer = document.getElementById("filter-origins"),
                tagsContainer    = document.getElementById("filter-tags");

            let categoriesHTML = originsHTML = tagsHTML = "";

            // build categories
            for ( let i = 0; i < data.categories.length; i++ ) {

                categoriesHTML += `<li class="active" data-type="categories" tabIndex="0">${data.categories[i]}</li>`;

            }
            categoriesContainer.children[2].innerHTML = categoriesHTML;

            // build origins
            for ( let i = 0; i < data.origins.length; i++ ) {

                originsHTML += `<li class="active" data-type="origins" tabIndex="0">${data.origins[i]}</li>`;

            }
            originsContainer.children[2].innerHTML = originsHTML;

            // build tags
            for ( let i = 0; i < data.tags.length; i++ ) {

                tagsHTML += `<li data-type="tags" tabIndex="0">${data.tags[i]}</li>`;

            }
            tagsContainer.children[2].innerHTML = tagsHTML;

            applyListeners();

        }

        // get data
        let data = {};
        let meals = {};

        get("/src/data.json").then(function(resolve){

            data = JSON.parse(resolve);
            meals = data.meals;

            categoriesFilter = data.categories;
            originsFilter = data.origins;

            buildDOM(data);

        }, function(error) {

            c_alert("Error", error);

        })


        // check if two arrays have at least one matching value function
        function arrayContains(arr1, arr2) {

            return arr2.some(function(v) {

                return arr1.indexOf(v) >= 0;

            });

        }

        // check if all array values are in another array
        function arrayContainsArray(superset, subset) {

            if (0 === subset.length) {

                return false;

            }

            return subset.every(function (value) {

                return (superset.indexOf(value) >= 0);

            });
        }


        // get meal function
        function getMeal() {

            let name = document.getElementById("result-container").children[0];
            let resultContainer = document.getElementById("result-container");
            let description = document.getElementById("result-container").children[1];
            let linksContainer = document.getElementById("result-container").children[2];

            let possibleMeals = [];
            let theFinalMeal = {};

            let radios = document.getElementsByName("tags-method");
            let filterTagMethod = "";

            resultContainer.style.display = "none";

            for ( let n = 0; n < radios.length; n++ ) {

                if ( radios[n].checked ) {

                    filterTagMethod = radios[n].value;

                }

            }

            // validate at least one category is selected
            if ( categoriesFilter.length === 0 ) {

                c_alert("Error", "There must be at least one category selected.")

            } else {

                for ( let i = 0; i < meals.length; i++ ) {

                    // check categories
                    if ( arrayContains(meals[i].categories, categoriesFilter) ) {

                        // check origins
                        if ( originsFilter.length <= 0 || (originsFilter.length > 0 && arrayContains(meals[i].origins, originsFilter)) ) {

                            // check tags
                            if ( tagsFilter.length > 0 ) {

                                // filtering all tags
                                if ( filterTagMethod === "all" ) {

                                    if ( arrayContainsArray(meals[i].tags, tagsFilter) ) {

                                        possibleMeals.push(meals[i]);

                                    }

                                }

                                // filtering any tags
                                if ( filterTagMethod === "any" ) {

                                    if ( arrayContains(meals[i].tags, tagsFilter) ) {

                                        possibleMeals.push(meals[i]);

                                    }

                                }


                            } else {

                                possibleMeals.push(meals[i]);

                            }

                        }

                    }

                }
                
            }

            // pick the final meal
            if ( possibleMeals.length === 0 ) {

                name.innerText = "Just Order Takeout";
                description.innerHTML = "<p>No meals were found using those particular filters :(</p><p>Try opening up your search a bit or <a href='https://github.com/shnibble/SomethingToCook#contributing' target='_BLANK'>contribute</a> more recipes to the repository.</p>";
                linksContainer.innerHTML = "";

            } else {

                let i = Math.floor((Math.random() * possibleMeals.length), + 0);
                theFinalMeal = possibleMeals[i];
                name.innerText = theFinalMeal.name;

                let l = document.createElement("a");
                let url = `http://www.google.com/search?q=${theFinalMeal.name.replace(" ", "+")}+recipe`;
                l.href = url;
                l.className = "search-recipe"
                l.target = "_BLANK";
                l.innerText = `Find "${theFinalMeal.name}" Recipes`;
                linksContainer.innerHTML = "";
                linksContainer.appendChild(l);

                // wikipedia testing
                let fetchTitle = theFinalMeal.wikipedia.split("/");
                fetchTitle = fetchTitle[fetchTitle.length-1];
                let fetchUrl =  "https://en.wikipedia.org/w/api.php?format=json&action=query&origin=*&prop=extracts&exintro&explaintext&redirects=1&titles=" + fetchTitle;
                fetch(
                    fetchUrl,
                {
                    method: "GET"
                }
                )
                .then(response => response.json())
                .then(json => {

                    let key = Object.keys(json.query.pages)[0];
                    let extract = json.query.pages[key].extract;
                    description.innerHTML = `${extract} <a class="wikipedia-link" href="${theFinalMeal.wikipedia}" target="_BLANK">[linked from Wikipedia]</a>`;

                })
                .catch(error => {

                    c_alert(error.message);

                });

                if ( theFinalMeal.categories.length > 1 ) {

                    let h = document.createElement("h3");
                    h.innerText = "Variations:"
                    linksContainer.appendChild(h);

                    for (let n = 0; n < theFinalMeal.categories.length; n++ ) {

                        let c = document.createElement("a");
                        let url = "http://www.google.com/search?q=" + theFinalMeal.categories[n].replace(" ", "+") + "+" + theFinalMeal.name.replace(" ", "+") + "+recipe";
                        c.href = url;
                        c.className = "search-recipe-variation"
                        c.target = "_BLANK";
                        c.innerText = theFinalMeal.categories[n];
                        linksContainer.appendChild(c);

                    }

                }

            }
            slideDown(resultContainer, 500);

        }
    </script>
</body>

</html>